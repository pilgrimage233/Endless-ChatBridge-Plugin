name: Dependency Update

on:
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š8ç‚¹æ£€æŸ¥ä¾èµ–æ›´æ–°
    - cron: '0 8 * * 1'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    name: Update Dependencies
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: Check for dependency updates
        run: |
          mvn versions:display-dependency-updates > dependency-updates.txt
          mvn versions:display-plugin-updates > plugin-updates.txt

      - name: Create issue for dependency updates
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let depUpdates = '';
            let pluginUpdates = '';
            
            try {
              depUpdates = fs.readFileSync('dependency-updates.txt', 'utf8');
              pluginUpdates = fs.readFileSync('plugin-updates.txt', 'utf8');
            } catch (error) {
              console.log('æ— æ³•è¯»å–æ›´æ–°æ–‡ä»¶');
              return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°
            const hasDepUpdates = depUpdates.includes('The following dependencies in Dependencies have newer versions:');
            const hasPluginUpdates = pluginUpdates.includes('The following plugin updates are available:');
            
            if (hasDepUpdates || hasPluginUpdates) {
              const title = `ğŸ”„ ä¾èµ–æ›´æ–°æ£€æŸ¥ - ${new Date().toISOString().split('T')[0]}`;
              let body = '## ğŸ“¦ ä¾èµ–æ›´æ–°æŠ¥å‘Š\n\n';
            
              if (hasDepUpdates) {
                body += '### ä¾èµ–æ›´æ–°\n```\n' + depUpdates + '\n```\n\n';
              }
            
              if (hasPluginUpdates) {
                body += '### æ’ä»¶æ›´æ–°\n```\n' + pluginUpdates + '\n```\n\n';
              }
            
              body += 'è¯·æ£€æŸ¥è¿™äº›æ›´æ–°å¹¶è€ƒè™‘å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚\n\n';
              body += '> æ­¤é—®é¢˜ç”±è‡ªåŠ¨åŒ–å·¥ä½œæµåˆ›å»º';
            
              // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç±»ä¼¼çš„issue
              const issues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                labels: 'dependencies'
              });
            
              const existingIssue = issues.data.find(issue => 
                issue.title.includes('ä¾èµ–æ›´æ–°æ£€æŸ¥')
              );
            
              if (existingIssue) {
                // æ›´æ–°ç°æœ‰issue
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: existingIssue.number,
                  body: body
                });
              } else {
                // åˆ›å»ºæ–°issue
                await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: ['dependencies', 'maintenance']
                });
              }
            }